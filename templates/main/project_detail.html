{% extends "/main/layout.html" %}

{% block additional_head %}
<link rel="stylesheet" href="{{url_for('static', filename='css/main/projects.css')}}">
<link rel="stylesheet" href="{{url_for('static', filename='css/main/board.css')}}">
<link rel="stylesheet" href="{{url_for('static', filename='css/main/modal.css')}}">
<link rel="stylesheet" href="{{url_for('static', filename='css/others/offcanvas.css')}}">
{% endblock %}

{% block content %}
    <div id="wsIndicator" class="ws-indicator ws-disconnected" style="display: none;">
        <i class="bi bi-wifi-off me-1"></i> Disconnected
    </div>

    <header class="bg-white border-bottom shadow-sm">
        <div class="container py-3">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                <div class="d-flex align-items-center gap-3 flex-grow-1">
                    <div class="d-flex align-items-center justify-content-center rounded p-2"
                        style="width: clamp(36px, 4vw, 48px); height: clamp(36px, 4vw, 48px);">
                        <i class="bi bi-folder" style="font-size: clamp(1.25rem, 2vw, 1.75rem);"></i>
                    </div>
                    <div>
                        <h1 class="fw-bold text-dark mb-0"
                            style="font-size: clamp(1.25rem, 2.5vw, 1.75rem);">
                            {{ project.project_name }}
                        </h1>
                        <p class="text-muted mb-0"
                            style="font-size: clamp(0.75rem, 1.5vw, 0.875rem);">
                            {{ project.description }}
                        </p>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <button class="btn btn-primary d-flex align-items-center gap-2 px-3 py-2"
                            style="font-size: clamp(0.75rem, 1.6vw, 0.875rem);"
                            data-bs-toggle="modal" 
                            data-bs-target="#addTaskModal">
                        <i class="bi bi-plus"></i>
                        <span>New Task</span>
                    </button>

                    <a
                        href="{{ url_for('view_members', project_id=project._id) }}"
                        class="btn btn-primary d-flex align-items-center gap-2 px-3 py-2"
                            style="font-size: clamp(0.75rem, 1.6vw, 0.875rem);">
                        <i class="bi bi-people"></i>
                        <span>View Members</span>
                    </a>
                </div>
            </div>
        </div>
    </header>
    
    {% if not columns %}
        <div class="empty-state">
            <div class="empty-state-content">
                <i class="bi bi-kanban fs-1"></i>
                <h3>No Columns Yet</h3>
                <p>Add a new column to start productivity</p>
                <button 
                    class="btn btn-primary"
                    data-bs-toggle="modal" 
                    data-bs-target="#addColumnModal">
                    <i class="bi bi-plus"></i>
                    Add Column
                </button>
            </div>
        </div>
    {% else %}
        <div class="kanban-board mt-4" id="kanbanBoard">
            {% for column in columns %}
            <div class="kanban-column bg-white rounded-3 shadow-sm border" 
                 data-column-id="{{ column._id }}"
                 data-column-color="{{ column.color if column.color else 'light-blue' }}">
                <div class="column-header p-3 rounded-top color-{{ column.color if column.color else 'light-blue' }}">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="h6 fw-semibold mb-0 d-flex align-items-center gap-2">
                            <i class="bi bi-list-task"></i>
                            <span>{{ column.label }}</span>
                        </h3>
                        <span class="badge bg-white bg-opacity-75 text-dark fw-medium px-2 py-1">
                            {{ column.tasks|length if column.tasks else 0 }}
                        </span>
                    </div>
                </div>
                <div class="p-3 d-flex flex-column gap-3 column-content" 
                     style="min-height: 24rem;"
                     data-column-id="{{ column._id }}"
                     ondrop="handleDrop(event)" 
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)">

                    {% if column.tasks %}
                        {% for task in column.tasks %}
                        <div class="task-card border" 
                             draggable="true"
                             data-task-id="{{ task._id }}"
                             ondragstart="handleDragStart(event)"
                             ondragend="handleDragEnd(event)">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h4 class="h6 fw-semibold text-dark mb-0">{{ task.title }}</h4>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge priority-{{ task.priority if task.priority else 'medium' }} text-white fw-medium">
                                        {{ task.priority.title() if task.priority else 'Medium' }}
                                    </span>
                                    <div class="task-menu">
                                        <button class="task-menu-btn" onclick="toggleTaskMenu(this)" type="button">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <div class="task-menu-dropdown">
                                            {% for col in columns %}
                                                {% if col._id != column._id %}
                                                <button class="task-menu-item" onclick="moveTask('{{ task._id }}', '{{ col._id }}')">
                                                    <i class="bi bi-arrow-right"></i>
                                                    Move to {{ col.label }}
                                                </button>
                                                {% endif %}
                                            {% endfor %}
                                            <hr class="my-1" style="margin: 0.25rem 0;">
                                            <button class="task-menu-item"
                                                onclick="editTask('{{ task._id }}')"
                                            >
                                                <i class="bi bi-pencil"></i>
                                                Edit Task
                                            </button>
                                            <button class="task-menu-item"
                                                onclick="viewTaskDetail('{{ task._id }}')"
                                            >
                                                <i class="bi bi-eye"></i>
                                                View Task Details
                                            </button>
                                            <button class="task-menu-item text-danger" onclick="deleteTask('{{ task._id }}')">
                                                <i class="bi bi-trash"></i>
                                                Delete Task
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% if task.description %}
                            <p class="text-muted small mb-2">{{ task.description }}</p>
                            {% endif %}
                            <div class="mb-2">
                                <span class="badge type-{{ task.type if task.type else 'task' }} text-white me-1">
                                    {{ task.type.title() if task.type else 'Task' }}
                                </span>
                                {% if task.labels %}
                                    {% for label in task.labels %}
                                    <span class="label-chip bg-info text-white">{{ label }}</span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center text-white small" 
                                         style="width: 24px; height: 24px;">
                                        {{ task.assignee_initials if task.assignee_initials else 'U' }}
                                    </div>
                                    <span class="small text-muted">{{ task.assignee_name if task.assignee_name else 'Unassigned' }}</span>
                                </div>

                                {% if task.due_date %}
                                <div class="d-flex align-items-center gap-1 small text-muted">
                                    <i class="bi bi-calendar"></i>
                                    <span>{{ task.due_date.strftime('%b %d') }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}

                    <button class="btn w-100 border border-2 border-dashed text-muted d-flex justify-content-center align-items-center gap-2 py-3 bg-white rounded transition"
                            data-bs-toggle="modal" 
                            data-bs-target="#addTaskModal"
                            data-column-id="{{ column._id }}">
                        <i class="bi bi-plus"></i>
                        <span>Add new task</span>
                    </button>
                </div>
            </div>
            {% endfor %}

            <div class="kanban-column">
                <div class="card d-flex align-items-center justify-content-center text-center border-dashed bg-light" 
                     style="width: 100%; height: 100%; min-height: 150px; cursor: pointer;"
                     data-bs-toggle="modal" 
                     data-bs-target="#addColumnModal">
                    <div>
                        <i class="bi bi-plus-lg fs-1 text-primary"></i>
                        <p class="mt-2 mb-0 fw-semibold text-muted">Add New Column</p>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    {% include './components/modals.html '%}
    {% include './components/offcanvas.html' %}

{% endblock %}

{% block scripts %}
<script>
window.PROJECT_ID = '{{ project._id }}';
window.USER_ID = '{{ session.get("user_id") }}';
window.USER_NAME = '{{ session.get("name", "Anonymous User") }}';
</script>

<script src="{{url_for('static', filename="js/task_form.js")}}"></script>
<script src="{{url_for('static', filename="js/modal.js")}}"></script>
<script src="{{url_for('static', filename="js/board.js")}}"></script>
<script src="{{url_for('static', filename="js/socket.js")}}"></script>
<script src="{{url_for('static', filename='js/task_detail.js')}}"></script>
{% endblock %}